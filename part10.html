<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 3200,
    height: 3200,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 500 },
            debug: true
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

//Toutes les variables nécessaires :

var player;
var stars;
var bombs;
var platforms;
var cursors;
var score = 0;
var gameOver = false;
var scoreText;
var attack = false;
var gun;
var boutonTir;
var groupeBullets;
var wallTime = 0;
var hp;
var health = 3;
var invincible = false;

    
var game = new Phaser.Game(config);


//Images, assets et spritesheets :

function preload ()
{
    this.load.image('sky', 'assets/background.png');
    this.load.image('ground', 'assets/ground.png');
    this.load.image('star', 'assets/star.png');
    this.load.image('bomb', 'assets/bomb.png');
    this.load.spritesheet('dude', 'assets/moutaineer.png', { frameWidth: 40, frameHeight: 60 });
    this.load.image('gun', 'assets/gun.png');
    this.load.image('snowball', 'assets/snowball.png');
    this.load.image('bear', 'assets/bear.png');
    this.load.image('ice','assets/ice.png');
    this.load.image('snow', 'assets/snow.png');
    this.load.image('snowIce', 'assets/snowIce.png');
    this.load.image('platform','assets/platform.png');
    this.load.image('snowblack', 'assets/snowBlack.png');
    this.load.image('leftWall', 'assets/leftWall.png');
    this.load.image('rightWall', 'assets/rightWall.png');
    this.load.image('midWall', 'assets/midWall.png');
    this.load.image('board', 'assets/board.png');
    this.load.image('flag', 'assets/flag.png');
    this.load.image('flag2', 'assets/flag2.png');
    this.load.image('flag3', 'assets/flag3.png');
    this.load.image('flake', 'assets/flake.png');
    this.load.image('snowman', 'assets/snowman.png');
    this.load.image('peak','assets/peak.png');
    this.load.image('icePeak', 'assets/icePeak.png');
    this.load.image('bigTree', 'assets/bigTree.png');
    this.load.image('littleTree', 'assets/littleTree.png');
}

function create ()
{

    //  Fond d'écran du jeu : 
    this.add.image(1600, 1600, 'sky');

    //Le groupe contenant nos plateformes
    platforms = this.physics.add.staticGroup();

    //Création des plateformes : 
    //Le sol
    platforms.create(1600,3200, 'ground').setScale(1).refreshBody();
    //les plateformes
    platforms.create(800,3065, 'platform').setScale(0.5).refreshBody();
    platforms.create(1300,2960, 'platform').setScale(0.5).refreshBody();
    platforms.create(1600,2960, 'platform').setScale(0.5).refreshBody();
    //Les murs
    platforms.create(1000,3114, 'midWall').setScale(1).refreshBody();
    platforms.create(1752,3070, 'midWall').setScale(2).refreshBody();
    

    //Positionnement de l'avatar : 
    player = this.physics.add.sprite(50, 3100, 'dude');

    //Placement du 1er ennemi à l'écran
    ours = this.physics.add.group({
        key: 'bear',
        repeat: 0,
        setXY: {x:450,y:2000}
    })

    // Propriété de l'avatar :
    player.direction='right';
    player.setBounce(0);
    player.setCollideWorldBounds(true);


    // Animations de l'avatar...
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
        frameRate: 5,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude', frame:4} ],
        frameRate: 20
    });
     

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
        frameRate: 5,
        repeat: -1
    });
    
    //...Avec implémentation du saut
    this.anims.create({
        key: 'jump_right',
        //frames : this.anims.generateFrameNumbers('dude', {start: 30, end: 32}),
        frames: [{ key: 'dude', frame: 31}],
        frameRate: 10,
        repeat: 1 
    });
    
    this.anims.create({
        key: 'jump_left',
        //frames : this.anims.generateFrameNumbers('dude', {start: 30, end: 32}),
        frames: [{ key: 'dude', frame: 23}],
        frameRate: 10,
        repeat: 1 
    });

    this.anims.create({
        key: 'wallJump_left',
        frames: [{ key: 'dude', frame: 17}],
        frameRate : 10,
        repeat: 1
    });

    this.anims.create({
        key: 'wallJump_right',
        frames: [{ key: 'dude', frame: 17}],
        frameRate : 10,
        repeat: 1
    });
    
   

    // Contrôles
    cursors = this.input.keyboard.createCursorKeys();
    boutonTir = this.input.keyboard.addKey('space');

    groupeBullets = this.physics.add.group();

    //  Some stars to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
    stars = this.physics.add.group({
        key: 'star',
        repeat: 11,
        setXY: { x: 12, y: 0, stepX:60 }
    });

    stars.children.iterate(function (child) {

        //  Give each star a slightly different bounce
        child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

    });

    bombs = this.physics.add.group();

    gun = this.physics.add.group({
        key: 'gun',
        repeat: 0,
        setXY: {x:170,y:3100}
    });
       
    //jauge de vie
    hp = this.add.image(1150,50,'flag3').setScrollFactor(0);

    //  The score
    scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

    //Interaction entre les différents éléments:
    this.physics.add.collider(player, platforms);
    this.physics.add.collider(stars, platforms);
    this.physics.add.collider(bombs, platforms);
    this.physics.add.collider(gun, platforms);
    this.physics.add.collider(ours, platforms);


    this.physics.add.overlap(player, ours, getDamage, null, this);
    this.physics.add.overlap(player, gun, getGun, null, this);
 
    //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
    this.physics.add.overlap(player, stars, collectStar, null, this);

    this.physics.add.collider(player, bombs, hitBomb, null, this);


    this.cameras.main.setBounds (0, 0, 3200, 3200);
    this.cameras.main.setSize (1280,720);
    this.cameras.main.startFollow (player);


}

function update ()
{
    if (gameOver)
    {
        return;
    }
    if (wallTime>0)
    {
        wallTime--
    }
   
    else if (cursors.up.isUp && !player.body.touching.down && player.direction == 'left' && player.body.blocked.left)
        {
            player.setVelocityY(-380);
            player.setVelocityX(160);
            var wallTime=50;
            player.anims.play('wallJump_left');
        }

    else if (cursors.up.isDown && player.body.touching.down)
    {
        player.setVelocityY(-330);
        player.anims.play('jump');
    }

    
    else if(cursors.up.isUp && !player.body.touching.down && player.direction == 'right')
        {
            player.anims.play('jump_right');
        }

    else if (cursors.up.isUp && !player.body.touching.down && player.direction == 'left')
        {
          
            player.anims.play('jump_left');
        }

    else if (cursors.left.isDown)
    {
        player.direction='left';
        player.setVelocityX(-160);
        

        player.anims.play('left', true);
    }
    else if (cursors.right.isDown)
    {
        player.direction='right';
        player.setVelocityX(160);

        player.anims.play('right', true);
    }

    else
        {
            player.setVelocityX(0);
            player.anims.play('turn');
        }

    if (Phaser.Input.Keyboard.JustDown(boutonTir)){
            if(attack==true){
            shot(player);
        }
    }
    
    if (health == 3)
    {
        hp.setTexture('flag3');
    }
    else if (health == 2)
    {
        hp.setTexture('flag2');
    }
    else if (health == 1)
    {
        hp.setTexture('flag');
    }
    else if (health == 0) 
    {
        player.destroy()
        hp.destroy()
    }
    
   
}
function getDamage (player, ours)
{  
    if (!invincible)
    health-- 
    invincible = true;
    tempsInvincible = this.time.addEvent({ delay: 2000, callback: function(){invincible = false;}, callbackScope: this});
    }

function getGun (player, gun)
{   
    gun.disableBody(true, true);
    attack=true;
}

function shot(player){
    var coefDir;
    if (player.direction == 'left') { coefDir = -1; } else { coefDir = 1 }
        // on crée la balle a coté du joueur
    var bullet = groupeBullets.create(player.x + (25 * coefDir), player.y - 2, 'snowball');
         // parametres physiques de la balle.
    bullet.setCollideWorldBounds(false);
    bullet.body.allowGravity =false;
    bullet.setVelocity(500 * coefDir, 0); // vitesse en x et en y
}


function collectStar (player, star)
{
    star.disableBody(true, true);

    //  Add and update the score
    score += 10;
    scoreText.setText('Score: ' + score);

    if (stars.countActive(true) === 0)
    {
        //  A new batch of stars to collect
        stars.children.iterate(function (child) {

            child.enableBody(true, child.x, 0, true, true);

        });

        var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

        var bomb = bombs.create(x, 16, 'bomb');
        bomb.setBounce(1);
        bomb.setCollideWorldBounds(true);
        bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
        bomb.allowGravity = false;

    }
}

function hitBomb (player, bomb)
{
    this.physics.pause();

    player.setTint(0xff0000);

    player.anims.play('turn');

    gameOver = true;
}

// Trouver le moyen d'ajouter une fonction qui provoque le game Over
</script>

</body>
</html>